<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borsa Terminali AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        .bg-gradient-primary { background: linear-gradient(45deg, #0d6efd, #0a58ca); color: white; }
        .score-box { font-size: 2.5rem; font-weight: bold; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; margin: 0 auto; }
        .chat-container { height: 400px; overflow-y: auto; background: #fff; border-radius: 10px; padding: 15px; border: 1px solid #dee2e6; }
        .message { margin-bottom: 10px; padding: 10px 15px; border-radius: 15px; max-width: 80%; }
        .user-message { background-color: #0d6efd; color: white; margin-left: auto; border-bottom-right-radius: 2px; }
        .ai-message { background-color: #e9ecef; color: #333; margin-right: auto; border-bottom-left-radius: 2px; }
        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite;}
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);} 40% { color: #333; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);} 60% { text-shadow: .25em 0 0 #333, .5em 0 0 rgba(0,0,0,0);} 80%, 100% { text-shadow: .25em 0 0 #333, .5em 0 0 #333;}}
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="#"><i class="fas fa-chart-line me-2"></i>Borsa Terminali</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/top_gainers">ğŸš€ En Ã‡ok Artanlar</a></li>
                <li class="nav-item"><a class="nav-link" href="/top_losers">ğŸ”» En Ã‡ok DÃ¼ÅŸenler</a></li>
                <li class="nav-item"><a class="nav-link" href="/top_volume">ğŸ“Š En Ã‡ok Hacim</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-md-4">
            <div class="card p-4">
                <h5 class="card-title mb-3">ğŸ” Hisse Analizi</h5>
                <form method="POST" action="/">
                    <div class="mb-3">
                        <label class="form-label">Hisse SembolÃ¼ (Ã–rn: THYAO)</label>
                        <input type="text" class="form-control" name="sembol" placeholder="BIST Kodu Girin" required value="{{ veri.isim if veri else '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lot SayÄ±sÄ± (Opsiyonel)</label>
                        <input type="number" class="form-control" name="adet" value="1">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Analiz Et</button>
                </form>
            </div>
            
            <div class="card mt-4">
                <div class="card-header bg-gradient-primary">
                    <i class="fas fa-robot me-2"></i>AI Borsa AsistanÄ±
                </div>
                <div class="card-body">
                    <div id="chat-box" class="chat-container mb-3">
                        <div class="message ai-message">
                            Merhaba! Ben borsa asistanÄ±nÄ±zÄ±m. Bana hisseler veya piyasa hakkÄ±nda soru sorabilirsiniz.
                        </div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="user-input" class="form-control" placeholder="Sorunuzu yazÄ±n...">
                        <button class="btn btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            {% if ai_summary %}
            <div class="alert alert-info border-0 shadow-sm">
                <h5><i class="fas fa-magic me-2"></i>Yapay Zeka Yorumu</h5>
                <p class="mb-0">{{ ai_summary }}</p>
            </div>
            {% endif %}

            {% if veri %}
            <div class="row mb-4">
                <div class="col-md-4 text-center">
                    <div class="card p-3">
                        <small class="text-muted">Fiyat</small>
                        <h3>{{ veri.fiyat }} â‚º</h3>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="card p-3">
                        <small class="text-muted">Algoritmik Puan</small>
                        <div class="score-box" style="background-color: {{ '#28a745' if veri.puan >= 3 else ('#ffc107' if veri.puan == 2 else '#dc3545') }}">
                            {{ veri.puan }}/4
                        </div>
                        <small class="mt-2 fw-bold">{{ veri.sinyal_yorum }}</small>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="card p-3">
                        <small class="text-muted">RSI (14)</small>
                        <h3 style="color: {{ veri.sinyal_rsi_renk }}">{{ veri.rsi }}</h3>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            F/K OranÄ±
                            <span class="badge bg-secondary rounded-pill">{{ veri.fk }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            P/DD OranÄ±
                            <span class="badge bg-secondary rounded-pill">{{ veri.pddd }}</span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            MACD Sinyali
                            <span class="badge rounded-pill" style="background-color: {{ veri.sinyal_macd_renk }}">
                                {{ "AL" if veri.sinyal_macd_renk == "#007bff" else "SAT" }}
                            </span>
                        </li>
                         <li class="list-group-item d-flex justify-content-between align-items-center">
                            Toplam Tutar
                            <span class="fw-bold">{{ veri.toplam_tutar }} â‚º</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="mt-4 text-end">
                <a href="/download_csv/{{ veri.isim }}" class="btn btn-success btn-sm"><i class="fas fa-download me-1"></i> Veriyi Ä°ndir (CSV)</a>
            </div>
            {% endif %}
            
            {% if veri and veri.hata %}
            <div class="alert alert-danger mt-3">
                {{ veri.hata }}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Enter tuÅŸuna basÄ±nca gÃ¶nderme
    document.getElementById("user-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    });

    function sendMessage() {
        var input = document.getElementById("user-input");
        var message = input.value.trim();
        if (message === "") return;

        // KullanÄ±cÄ± mesajÄ±nÄ± ekrana bas
        var chatBox = document.getElementById("chat-box");
        chatBox.innerHTML += `<div class="message user-message">${message}</div>`;
        input.value = "";
        
        // "YazÄ±yor..." animasyonu ekle
        var loadingId = "loading-" + Date.now();
        chatBox.innerHTML += `<div id="${loadingId}" class="message ai-message loading-dots">AI dÃ¼ÅŸÃ¼nÃ¼yor</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;

        // Backend'e gÃ¶nder
        fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            // "YazÄ±yor..." mesajÄ±nÄ± sil
            document.getElementById(loadingId).remove();
            
            // GerÃ§ek cevabÄ± ekle
            var reply = data.reply;
            // EÄŸer cevap boÅŸ gelirse uyarÄ± ver
            if (!reply) reply = "âš ï¸ Cevap alÄ±namadÄ±. LÃ¼tfen tekrar deneyin.";
            
            chatBox.innerHTML += `<div class="message ai-message">${reply}</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        })
        .catch(error => {
            document.getElementById(loadingId).remove();
            chatBox.innerHTML += `<div class="message ai-message text-danger">BaÄŸlantÄ± HatasÄ±: ${error}</div>`;
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>